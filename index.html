<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Logic Master Pro - Strict Batch Filter</title>
    <style>
        :root { --primary: #27ae60; --info: #2980b9; --dark: #2c3e50; --bg: #f4f7f6; --warning: #f1c40f; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg); padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 100%; max-width: 650px; }
        h2 { color: var(--dark); text-align: center; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .section { padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #eee; transition: 0.3s; }
        .encode-bg { background-color: #f0fff4; border-color: #c6f6d5; }
        .decode-bg { background-color: #f0f7ff; border-color: #bee3f8; }
        
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #4a5568; font-size: 0.9em; }
        input { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1.25em; text-align: center; box-sizing: border-box; }
        
        button { padding: 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; color: white; width: 100%; font-size: 1.1em; margin-top: 10px; transition: 0.2s; }
        button:disabled { background-color: #cbd5e0; cursor: not-allowed; }
        .btn-encode { background-color: var(--dark); }
        .btn-decode { background-color: var(--info); }
        
        .result-display { margin-top: 20px; text-align: center; border-top: 2px dashed #eee; padding-top: 15px; min-height: 1.5em; }
        .res-item { margin-bottom: 15px; font-size: 1.8em; font-weight: bold; color: var(--dark); display: flex; flex-direction: column; align-items: center; }
        .badge { font-size: 0.4em; padding: 4px 10px; border-radius: 5px; color: white; margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; }
        
        .remark-box { background: #fff3cd; padding: 12px; border-radius: 10px; color: #856404; font-size: 0.85em; border: 1px solid #ffeeba; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2>QR Logic Master Pro</h2>

    <div class="section encode-bg">
        <label>1. สร้างรหัส QR (ป้อน Serial 8 หลัก)</label>
        <input type="text" id="serialIn" placeholder="ป้อนเลข 0, 1, 2, 3 นำหน้าเท่านั้น" maxlength="8" oninput="vInput(this, 8, 'btnE', true)">
        <button id="btnE" class="btn-encode" onclick="processEncode()" disabled>สร้างรหัส QR Code</button>
        <div id="resE" class="result-display"></div>
    </div>

    <div class="section decode-bg">
        <label>2. ถอดรหัสย้อนกลับ (กรองเฉพาะช่วง 0-1 และ 2-3)</label>
        <input type="text" id="qrIn" placeholder="เช่น P4RYT" maxlength="5" style="text-transform: uppercase;" oninput="vInput(this, 5, 'btnD', false)">
        <button id="btnD" class="btn-decode" onclick="processDecode()" disabled>ถอดรหัส (Strict Filter)</button>
        <div id="resD" class="result-display"></div>
    </div>

    <div class="remark-box">
        <b>⚠️ Remark:</b> ข้อมูลชุดนี้วิเคราะห์จากกลุ่มตัวอย่างจำนวนน้อย (Sample) หากคำนวณแล้วได้เลขในช่วงอื่น (เช่น 4, 5, 6...) ระบบจะกรองออกเพราะถือว่าไม่เข้ากฎ Batch ปัจจุบันครับ
    </div>
</div>

<script>
    const ABC = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const M1 = 60466176n; const A1 = 35477987n; const C1 = 46913010n; const INV1 = 46213067n;
    const MOD2 = 100000000n; const MULT2 = 32216237n; const OFF2 = 42413113n;

    function vInput(el, len, btnId, isNum) {
        el.value = isNum ? el.value.replace(/\D/g, '') : el.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
        document.getElementById(btnId).disabled = (el.value.length !== len);
    }

    function processEncode() {
        const sStr = document.getElementById('serialIn').value;
        const sVal = parseInt(sStr);
        const sBig = BigInt(sStr);
        let res = "", mode = "", color = "";

        if (sVal < 20000000) { // Batch 0-1 (New Formula)
            for(let m=0n; m<3n; m++) {
                let x = sBig + m * MOD2;
                for(let i=0; i<36; i++) {
                    let k = (MULT2 * BigInt(i) + OFF2) % MOD2;
                    let n = x - k;
                    if(n >= 0n && n < M1) {
                        let tempQR = "", tn = Number(n);
                        for(let j=4; j>=0; j--) { let p=Math.pow(36,j); tempQR+=ABC[Math.floor(tn/p)]; tn%=p; }
                        if(ABC.indexOf(tempQR[1]) === i) { res = tempQR; break; }
                    }
                }
                if(res) break;
            }
            mode = "NEW FORMULA (0-1)"; color = "#3498db";
        } else if (sVal >= 20000000 && sVal < 40000000) { // Batch 2-3 (Legacy)
            const r = (sBig * A1 + C1) % M1;
            let tempQR = "", n = Number(r);
            for(let i=4; i>=0; i--) { let p=Math.pow(36,i); tempQR+=ABC[Math.floor(n/p)]; n%=p; }
            res = tempQR; mode = "LEGACY FORMULA (2-3)"; color = "#27ae60";
        } else {
            res = "ไม่อยู่ในเงื่อนไข 0-3"; color = "#e74c3c";
        }
        document.getElementById('resE').innerHTML = `<div class="res-item">${res} <span class="badge" style="background:${color}">${mode}</span></div>`;
    }

    function processDecode() {
        const qr = document.getElementById('qrIn').value.toUpperCase();
        const resD = document.getElementById('resD');
        let r = 0n; for(let i=0; i<5; i++) r = r * 36n + BigInt(ABC.indexOf(qr[i]));

        let results = [];

        // 1. ถอดสูตรใหม่ (เช็คว่าได้ 0-1 หรือไม่)
        const k = (MULT2 * BigInt(ABC.indexOf(qr[1])) + OFF2) % MOD2;
        let sNew = (r + k) % MOD2;
        if (sNew >= 0n && sNew < 20000000n) {
            results.push({ serial: sNew, mode: 'BATCH 0-1', color: '#3498db' });
        }

        // 2. ถอดสูตรเดิม (เช็คว่าได้ 2-3 หรือไม่)
        let st = (r - C1) % M1; if(st < 0n) st += M1;
        let sOld = (st * INV1) % M1;
        if (sOld >= 20000000n && sOld < 40000000n) {
            results.push({ serial: sOld, mode: 'BATCH 2-3', color: '#27ae60' });
        }

        if (results.length === 0) {
            resD.innerHTML = '<span style="color:red; font-size:0.8em;">ไม่พบหมายเลขในช่วง 0-3 ที่ถูกต้อง</span>';
        } else {
            resD.innerHTML = results.map(res => `
                <div class="res-item">
                    ${res.serial.toString().padStart(8, '0')}
                    <span class="badge" style="background:${res.color}">${res.mode}</span>
                </div>
            `).join('');
        }
    }
</script>
</body>
</html>
