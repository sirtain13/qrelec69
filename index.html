<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Logic Master - Double Strict Mode</title>
    <style>
        :root {
            --primary: #2ecc71;
            --dark: #2c3e50;
            --bg: #f4f7f6;
            --info: #3498db;
            --danger: #e74c3c;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg); padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 650px; }
        h2 { color: var(--dark); text-align: center; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .section { padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #eee; }
        .encode-bg { background-color: #f0fff4; border-color: #c6f6d5; }
        .decode-bg { background-color: #f0f7ff; border-color: #bee3f8; }
        
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #4a5568; font-size: 0.9em; }
        .input-group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        
        input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1.1em; text-align: center; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: var(--info); outline: none; }
        input.invalid { border-color: var(--danger); background-color: #fff5f5; }
        
        .error-msg { color: var(--danger); font-size: 0.8em; min-height: 1.2em; margin-bottom: 10px; display: none; }

        button { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; width: 100%; transition: 0.2s; }
        button:disabled { background-color: #cbd5e0; cursor: not-allowed; }
        button:active:not(:disabled) { transform: scale(0.98); }
        
        .btn-encode { background-color: var(--primary); }
        .btn-decode { background-color: var(--info); }
        
        .result-display { margin-top: 15px; text-align: center; font-size: 1.6em; font-weight: bold; color: var(--dark); min-height: 1.2em; border-top: 1px dashed #ddd; pt: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>QR Logic Master (Strict Mode)</h2>

    <div class="section encode-bg">
        <label>1. แปลง Serial เป็น QR (ระบุเลขให้ครบ 8 หลัก)</label>
        <div class="input-group">
            <input type="text" id="serialIn" 
                   placeholder="เช่น 14399212" 
                   maxlength="8" 
                   oninput="validateInput(this, 8, 'serialError', 'btnEncode', true)">
            <div id="serialError" class="error-msg">กรุณาระบุตัวเลขให้ครบ 8 หลัก</div>
        </div>
        <button id="btnEncode" class="btn-encode" onclick="doEncode()" disabled>สร้างรหัส QR</button>
        <div id="resEncode" class="result-display"></div>
    </div>

    <div class="section decode-bg">
        <label>2. ถอดรหัส QR เป็น Serial (ระบุรหัสให้ครบ 5 หลัก)</label>
        <div class="input-group">
            <input type="text" id="qrIn" 
                   placeholder="เช่น EH1RQ" 
                   maxlength="5" 
                   style="text-transform: uppercase;"
                   oninput="validateInput(this, 5, 'qrError', 'btnDecode', false)">
            <div id="qrError" class="error-msg">กรุณาระบุรหัสให้ครบ 5 หลัก (A-Z, 0-9)</div>
        </div>
        <button id="btnDecode" class="btn-decode" onclick="doDecode()" disabled>ถอดรหัสเป็น Serial</button>
        <div id="resDecode" class="result-display" style="color: var(--info);"></div>
    </div>
</div>

<script>
    const M = BigInt(60466176);
    const A = BigInt(35477987);
    const B = BigInt(46913010);
    const INV = BigInt(46213067); // กุญแจที่ถูกต้อง
    const ALPHABET = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";

    // ฟังก์ชันตรวจสอบ Input ส่วนกลาง
    function validateInput(el, requiredLength, errorId, btnId, isNumericOnly) {
        let val = el.value;
        const btn = document.getElementById(btnId);
        const error = document.getElementById(errorId);
        
        // กรองข้อมูลตามประเภท
        if (isNumericOnly) {
            el.value = val.replace(/\D/g, ''); // เอาเฉพาะตัวเลข
        } else {
            el.value = val.replace(/[^a-zA-Z0-9]/g, '').toUpperCase(); // เอา A-Z และ 0-9
        }
        
        if (el.value.length === requiredLength) {
            el.classList.remove('invalid');
            error.style.display = 'none';
            btn.disabled = false;
        } else {
            if (el.value.length > 0) {
                el.classList.add('invalid');
                error.style.display = 'block';
            } else {
                error.style.display = 'none';
            }
            btn.disabled = true;
        }
    }

    function toBase36(num) {
        let res = "";
        let n = Number(num);
        for (let i = 4; i >= 0; i--) {
            let p = Math.pow(36, i);
            let idx = Math.floor(n / p);
            res += ALPHABET[idx];
            n %= p;
        }
        return res;
    }

    function fromBase36(str) {
        let r = BigInt(0);
        for (let i = 0; i < str.length; i++) {
            r = r * 36n + BigInt(ALPHABET.indexOf(str[i]));
        }
        return r;
    }

    function doEncode() {
        const val = document.getElementById('serialIn').value;
        const s = BigInt(val);
        const r = (s * A + B) % M;
        document.getElementById('resEncode').innerText = toBase36(r);
    }

    function doDecode() {
        const val = document.getElementById('qrIn').value;
        const r = fromBase36(val);
        let step1 = (r - B) % M;
        if (step1 < 0n) step1 += M;
        const serial = (step1 * INV) % M;
        document.getElementById('resDecode').innerText = serial.toString().padStart(8, '0');
    }

    // กด Enter เพื่อทำงาน
    document.getElementById('serialIn').addEventListener('keypress', (e) => {
        if(e.key === 'Enter' && !document.getElementById('btnEncode').disabled) doEncode();
    });
    document.getElementById('qrIn').addEventListener('keypress', (e) => {
        if(e.key === 'Enter' && !document.getElementById('btnDecode').disabled) doDecode();
    });
</script>

</body>
</html>
