<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Logic Master Pro v2 - Smart Validation</title>
    <style>
        :root { 
            --primary: #27ae60; 
            --info: #2980b9; 
            --dark: #2c3e50; 
            --bg: #f4f7f6; 
            --warning: #f39c12;
            --danger: #e74c3c;
            --success: #27ae60;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px; 
            display: flex; 
            justify-content: center;
            min-height: 100vh;
        }
        
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            width: 100%; 
            max-width: 750px;
            margin: 20px 0;
        }
        
        h2 { 
            color: var(--dark); 
            text-align: center; 
            margin-bottom: 10px; 
            border-bottom: 3px solid #667eea; 
            padding-bottom: 10px;
            font-size: 1.8em;
        }
        
        .version {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.85em;
            margin-bottom: 20px;
        }
        
        .section { 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            border: 2px solid #eee; 
            transition: 0.3s;
            background: white;
        }
        
        .section:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        .encode-bg { border-left: 4px solid #27ae60; }
        .decode-bg { border-left: 4px solid #2980b9; }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: bold; 
            color: #4a5568; 
            font-size: 0.95em;
        }
        
        input { 
            width: 100%; 
            padding: 14px; 
            border: 2px solid #e2e8f0; 
            border-radius: 10px; 
            font-size: 1.25em; 
            text-align: center; 
            box-sizing: border-box;
            transition: 0.2s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button { 
            padding: 15px; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: bold; 
            color: white; 
            width: 100%; 
            font-size: 1.1em; 
            margin-top: 10px; 
            transition: 0.2s;
        }
        
        button:disabled { 
            background-color: #cbd5e0; 
            cursor: not-allowed;
        }
        
        button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-encode { background: linear-gradient(135deg, #27ae60, #229954); }
        .btn-decode { background: linear-gradient(135deg, #2980b9, #1f5f8b); }
        
        .result-display { 
            margin-top: 20px; 
            text-align: center; 
            border-top: 2px dashed #eee; 
            padding-top: 15px; 
            min-height: 1.5em;
        }
        
        .res-item { 
            margin-bottom: 15px; 
            font-size: 2em; 
            font-weight: bold; 
            color: var(--dark); 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .badge { 
            font-size: 0.4em; 
            padding: 5px 12px; 
            border-radius: 5px; 
            color: white; 
            margin-top: 8px; 
            text-transform: uppercase; 
            letter-spacing: 1px;
        }
        
        .validation-info {
            font-size: 0.35em;
            color: #666;
            margin-top: 8px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        
        .check-item {
            display: inline-block;
            margin: 0 8px;
            font-weight: normal;
        }
        
        .info-box {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        .info-box h3 {
            margin-top: 0;
            color: #1565c0;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-box ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .info-box li {
            margin: 8px 0;
            color: #424242;
            line-height: 1.6;
        }
        
        .logic-box {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 4px solid #ff9800;
        }
        
        .logic-box h3 {
            margin-top: 0;
            color: #e65100;
            font-size: 1.1em;
        }
        
        .logic-step {
            background: white;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 3px solid #ff9800;
        }
        
        .logic-step strong {
            color: #e65100;
        }
        
        .code-example {
            background: #263238;
            color: #aed581;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .remark-box { 
            background: #fff3cd; 
            padding: 15px; 
            border-radius: 10px; 
            color: #856404; 
            font-size: 0.9em; 
            border: 2px solid #ffc107; 
            margin-top: 20px;
        }
        
        .error-msg {
            color: var(--danger);
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .success-msg {
            color: var(--success);
            font-size: 0.9em;
            margin-top: 10px;
        }

        details {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        summary {
            cursor: pointer;
            font-weight: bold;
            color: #495057;
            padding: 5px;
            user-select: none;
        }

        summary:hover {
            color: #667eea;
        }

        .formula-info {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            font-size: 0.9em;
            line-height: 1.6;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>üîê QR Logic Master Pro v2</h2>
    <div class="version">Smart Validation System with 3-Rule Filter</div>

    <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£ -->
    <div class="info-box">
        <h3>üí° ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö</h3>
        <ul>
            <li><strong>‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ 2 ‡∏™‡∏π‡∏ï‡∏£:</strong> Legacy Formula (‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏î‡∏¥‡∏°) ‡πÅ‡∏•‡∏∞ New Formula (‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà)</li>
            <li><strong>‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</strong> QR Code 1 ‡∏ï‡∏±‡∏ß ‡∏≠‡∏≤‡∏à‡∏ñ‡∏≠‡∏î‡πÑ‡∏î‡πâ 2 Serial ‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô</li>
            <li><strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</strong> ‡πÉ‡∏ä‡πâ <strong>‡∏Å‡∏é 3 ‡∏Ç‡πâ‡∏≠</strong> ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
        </ul>
    </div>

    <div class="logic-box">
        <h3>üéØ ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô 3 ‡∏Ç‡πâ‡∏≠ (Validation Rules)</h3>
        
        <div class="logic-step">
            <strong>‡∏Å‡∏é‡∏ó‡∏µ‡πà 1:</strong> QR Code ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (0-9) ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß
            <div class="code-example">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: I4SR8 ‚úì (‡∏°‡∏µ 4,8) | JBTCL ‚úó (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç)</div>
        </div>

        <div class="logic-step">
            <strong>‡∏Å‡∏é‡∏ó‡∏µ‡πà 2:</strong> Serial ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Batch 0-3 (00000000-39999999)
            <div class="code-example">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: B14859526 ‚úì (Batch 0-1) | B82443355 ‚úó (Batch 4+)</div>
        </div>

        <div class="logic-step">
            <strong>‡∏Å‡∏é‡∏ó‡∏µ‡πà 3:</strong> ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á QR ‡∏ö‡∏≠‡∏Å Batch
            <div class="code-example">
0-9, A-I (index 0-18)  ‚Üí Batch 0-1<br>
P-Z (index 25-35)      ‚Üí Batch 2-3<br>
J-O (index 19-24)      ‚Üí ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
            </div>
        </div>

        <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 8px;">
            <strong>üí≠ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</strong><br>
            QR: <code>IMAF8</code> ‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏î‡πâ 2 ‡∏Ñ‡πà‡∏≤<br>
            ‚Üí <code>B14859526</code> (Legacy, Batch 0-1, ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å='I'=18) ‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á 3 ‡∏Å‡∏é<br>
            ‚Üí <code>B82443355</code> (New, Batch 4+, ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å='I'=18) ‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏é‡∏ó‡∏µ‡πà 2 ‡πÅ‡∏•‡∏∞ 3<br>
            <strong>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö:</strong> <code>B14859526</code>
        </div>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™ -->
    <div class="section encode-bg">
        <label>1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ QR (‡∏õ‡πâ‡∏≠‡∏ô Serial 8 ‡∏´‡∏•‡∏±‡∏Å)</label>
        <input type="text" id="serialIn" placeholder="‡πÄ‡∏ä‡πà‡∏ô 01735041 ‡∏´‡∏£‡∏∑‡∏≠ 14859526" maxlength="8" oninput="vInput(this, 8, 'btnE', true)">
        <button id="btnE" class="btn-encode" onclick="processEncode()" disabled>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ QR Code</button>
        <div id="resE" class="result-display"></div>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™ -->
    <div class="section decode-bg">
        <label>2. ‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡∏î‡πâ‡∏ß‡∏¢ Smart Validation (‡∏õ‡πâ‡∏≠‡∏ô QR 5 ‡∏ï‡∏±‡∏ß)</label>
        <input type="text" id="qrIn" placeholder="‡πÄ‡∏ä‡πà‡∏ô I4SR8 ‡∏´‡∏£‡∏∑‡∏≠ IMAF8" maxlength="5" style="text-transform: uppercase;" oninput="vInput(this, 5, 'btnD', false)">
        <button id="btnD" class="btn-decode" onclick="processDecode()" disabled>‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™ (3-Rule Filter)</button>
        <div id="resD" class="result-display"></div>
    </div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
    <details>
        <summary>üìñ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏ï‡∏£ Legacy ‡πÅ‡∏•‡∏∞ New</summary>
        <div class="formula-info">
            <strong>Legacy Formula (‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏î‡∏¥‡∏°):</strong><br>
            ‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö Batch ‡∏ó‡∏±‡πâ‡∏á 0-1 ‡πÅ‡∏•‡∏∞ 2-3<br>
            ‚Ä¢ r = (Serial √ó 35477987 + 46913010) mod 60466176<br>
            ‚Ä¢ ‡πÅ‡∏õ‡∏•‡∏á r ‡πÄ‡∏õ‡πá‡∏ô base-36 (5 ‡∏´‡∏•‡∏±‡∏Å) = QR Code<br><br>

            <strong>New Formula (‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà):</strong><br>
            ‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö Batch 0-1<br>
            ‚Ä¢ ‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏ß‡πà‡∏≤ ‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà 2 ‡∏Ç‡∏≠‡∏á QR<br>
            ‚Ä¢ ‡πÉ‡∏ä‡πâ modulo 100000000 ‡πÅ‡∏•‡∏∞ offset ‡∏ï‡πà‡∏≤‡∏á‡πÜ
        </div>
    </details>

    <div class="remark-box">
        <strong>‚ö†Ô∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong><br>
        ‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ prefix "B" ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ Serial ‡πÄ‡∏™‡∏°‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô B01735041)<br>
        ‚Ä¢ QR Code ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Serial 8 ‡∏´‡∏•‡∏±‡∏Å (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö "B")<br>
        ‚Ä¢ ‡∏´‡∏≤‡∏Å QR ‡∏ñ‡∏≠‡∏î‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏é‡∏ó‡∏±‡πâ‡∏á 3 ‡∏Ç‡πâ‡∏≠<br>
        ‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å Sample ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏´‡∏≤‡∏Å Serial ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á 0-3 ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    </div>
</div>

<script>
    const ABC = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    
    // Legacy Formula Constants
    const M1 = 60466176n;
    const A1 = 35477987n;
    const C1 = 46913010n;
    const INV1 = 46213067n;
    
    // New Formula Constants
    const MOD2 = 100000000n;
    const MULT2 = 32216237n;
    const OFF2 = 42413113n;

    function vInput(el, len, btnId, isNum) {
        el.value = isNum ? el.value.replace(/\D/g, '') : el.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
        document.getElementById(btnId).disabled = (el.value.length !== len);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏é
    function validateQR(qr) {
        // ‡∏Å‡∏é‡∏ó‡∏µ‡πà 1: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        const hasDigit = /\d/.test(qr);
        return hasDigit;
    }

    function validateSerial(serial, qr) {
        const sBig = BigInt(serial);
        
        // ‡∏Å‡∏é‡∏ó‡∏µ‡πà 2: ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Batch 0-3
        if (sBig >= 40000000n) return { valid: false, reason: "‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á Batch 0-3" };
        
        // ‡∏Å‡∏é‡∏ó‡∏µ‡πà 3: ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á QR ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Batch
        const firstIdx = ABC.indexOf(qr[0]);
        const batch = sBig < 20000000n ? "0-1" : "2-3";
        
        let expectedBatch = "";
        if (firstIdx <= 18) expectedBatch = "0-1";
        else if (firstIdx >= 25) expectedBatch = "2-3";
        else expectedBatch = "?";
        
        if (expectedBatch !== "?" && expectedBatch !== batch) {
            return { valid: false, reason: `‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á (‡∏Ñ‡∏≤‡∏î ${expectedBatch}, ‡∏à‡∏£‡∏¥‡∏á ${batch})` };
        }
        
        return { valid: true, batch: batch };
    }

    function encodeLegacy(serial) {
        const r = (serial * A1 + C1) % M1;
        let qr = "";
        let n = Number(r);
        for (let i = 4; i >= 0; i--) {
            const p = Math.pow(36, i);
            qr += ABC[Math.floor(n / p)];
            n %= p;
        }
        return qr;
    }

    function encodeNew(serial) {
        for (let m = 0n; m < 3n; m++) {
            const x = serial + m * MOD2;
            for (let i = 0; i < 36; i++) {
                const k = (MULT2 * BigInt(i) + OFF2) % MOD2;
                const n = x - k;
                if (n >= 0n && n < M1) {
                    let tempQR = "";
                    let tn = Number(n);
                    for (let j = 4; j >= 0; j--) {
                        const p = Math.pow(36, j);
                        tempQR += ABC[Math.floor(tn / p)];
                        tn %= p;
                    }
                    if (ABC.indexOf(tempQR[1]) === i) {
                        return tempQR;
                    }
                }
            }
        }
        return null;
    }

    function processEncode() {
        const sStr = document.getElementById('serialIn').value;
        const serial = BigInt(sStr);
        const resE = document.getElementById('resE');
        
        // ‡∏•‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á 2 ‡∏™‡∏π‡∏ï‡∏£
        const qrLegacy = encodeLegacy(serial);
        const qrNew = encodeNew(serial);
        
        const results = [];
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Legacy
        if (validateQR(qrLegacy)) {
            const validation = validateSerial(Number(serial), qrLegacy);
            if (validation.valid) {
                results.push({
                    qr: qrLegacy,
                    formula: "Legacy",
                    batch: validation.batch,
                    color: validation.batch === "0-1" ? "#3498db" : "#27ae60"
                });
            }
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö New
        if (qrNew && validateQR(qrNew)) {
            const validation = validateSerial(Number(serial), qrNew);
            if (validation.valid) {
                results.push({
                    qr: qrNew,
                    formula: "New",
                    batch: validation.batch,
                    color: "#9b59b6"
                });
            }
        }
        
        if (results.length === 0) {
            resE.innerHTML = '<span class="error-msg">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏é‡πÑ‡∏î‡πâ</span>';
        } else {
            resE.innerHTML = results.map(r => `
                <div class="res-item">
                    ${r.qr}
                    <span class="badge" style="background:${r.color}">${r.formula} (Batch ${r.batch})</span>
                    <div class="validation-info">
                        <span class="check-item">‚úì ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</span>
                        <span class="check-item">‚úì Batch 0-3</span>
                        <span class="check-item">‚úì ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ï‡∏£‡∏á</span>
                    </div>
                </div>
            `).join('');
        }
    }

    function decodeLegacy(qr) {
        let r = 0n;
        for (let i = 0; i < 5; i++) {
            r = r * 36n + BigInt(ABC.indexOf(qr[i]));
        }
        let st = (r - C1) % M1;
        if (st < 0n) st += M1;
        return (st * INV1) % M1;
    }

    function decodeNew(qr) {
        let r = 0n;
        for (let i = 0; i < 5; i++) {
            r = r * 36n + BigInt(ABC.indexOf(qr[i]));
        }
        const secondIdx = ABC.indexOf(qr[1]);
        const k = (MULT2 * BigInt(secondIdx) + OFF2) % MOD2;
        return (r + k) % MOD2;
    }

    function processDecode() {
        const qr = document.getElementById('qrIn').value.toUpperCase();
        const resD = document.getElementById('resD');
        
        // ‡∏Å‡∏é‡∏ó‡∏µ‡πà 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!validateQR(qr)) {
            resD.innerHTML = '<span class="error-msg">‚ùå QR ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏é‡∏ó‡∏µ‡πà 1: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß</span>';
            return;
        }
        
        const results = [];
        
        // ‡∏ñ‡∏≠‡∏î‡∏î‡πâ‡∏ß‡∏¢ Legacy
        const sLegacy = decodeLegacy(qr);
        const qrVerifyLegacy = encodeLegacy(sLegacy);
        if (qrVerifyLegacy === qr) {
            const validation = validateSerial(Number(sLegacy), qr);
            const checks = {
                hasDigit: true,
                inBatch03: validation.valid || validation.reason === "‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á",
                firstCharMatch: validation.valid
            };
            results.push({
                serial: sLegacy,
                formula: "Legacy",
                validation: validation,
                checks: checks,
                allPass: checks.hasDigit && checks.inBatch03 && checks.firstCharMatch
            });
        }
        
        // ‡∏ñ‡∏≠‡∏î‡∏î‡πâ‡∏ß‡∏¢ New
        const sNew = decodeNew(qr);
        const qrVerifyNew = encodeNew(sNew);
        if (qrVerifyNew === qr) {
            const validation = validateSerial(Number(sNew), qr);
            const checks = {
                hasDigit: true,
                inBatch03: validation.valid || validation.reason.includes("‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å"),
                firstCharMatch: validation.valid
            };
            results.push({
                serial: sNew,
                formula: "New",
                validation: validation,
                checks: checks,
                allPass: checks.hasDigit && checks.inBatch03 && checks.firstCharMatch
            });
        }
        
        // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Å‡∏é
        const validResults = results.filter(r => r.allPass);
        
        if (validResults.length === 0) {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏é‡πÑ‡∏´‡∏ô
            if (results.length > 0) {
                resD.innerHTML = '<div style="color: #e74c3c; margin-bottom: 15px; font-weight: bold;">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏é‡∏ó‡∏±‡πâ‡∏á 3 ‡∏Ç‡πâ‡∏≠</div>' + 
                    results.map(r => {
                        const batch = r.serial < 20000000n ? "0-1" : r.serial < 40000000n ? "2-3" : "4+";
                        const color = batch === "0-1" ? "#95a5a6" : batch === "2-3" ? "#95a5a6" : "#95a5a6";
                        return `
                            <div class="res-item" style="opacity: 0.6;">
                                B${r.serial.toString().padStart(8, '0')}
                                <span class="badge" style="background:${color}">${r.formula} (Batch ${batch})</span>
                                <div class="validation-info" style="color: #e74c3c;">
                                    <span class="check-item">${r.checks.hasDigit ? '‚úì' : '‚úó'} ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</span>
                                    <span class="check-item">${r.checks.inBatch03 ? '‚úì' : '‚úó'} Batch 0-3</span>
                                    <span class="check-item">${r.checks.firstCharMatch ? '‚úì' : '‚úó'} ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ï‡∏£‡∏á</span>
                                </div>
                            </div>
                        `;
                    }).join('');
            } else {
                resD.innerHTML = '<span class="error-msg">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏î‡πâ</span>';
            }
        } else {
            resD.innerHTML = validResults.map(r => {
                const batch = r.validation.batch;
                const color = batch === "0-1" ? "#3498db" : "#27ae60";
                return `
                    <div class="res-item">
                        B${r.serial.toString().padStart(8, '0')}
                        <span class="badge" style="background:${color}">${r.formula} (Batch ${batch})</span>
                        <div class="validation-info">
                            <span class="check-item">‚úì ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</span>
                            <span class="check-item">‚úì Batch 0-3</span>
                            <span class="check-item">‚úì ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ï‡∏£‡∏á</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (validResults.length > 1) {
                resD.innerHTML += '<div class="success-msg">‚úÖ ‡∏û‡∏ö ' + validResults.length + ' ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏é</div>';
            }
        }
    }
</script>
</body>
</html>
